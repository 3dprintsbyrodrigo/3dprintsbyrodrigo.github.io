<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Subir Imagen - 3D Prints by Rodrigo</title>
<style>
body { background:#111; color:#eee; font-family:Inter,sans-serif; padding:40px; }
input, button { padding:8px; margin:8px 0; width:100%; border-radius:5px; border:none; }
button { background:#333; color:#eee; cursor:pointer; }
button:hover { background:#555; }
</style>
</head>
<body>

<h1>Subir Imagen a la Galería</h1>
<p>Panel privado.</p>

<form id="uploadForm">
  <label>Título de la imagen:</label>
  <input type="text" id="titulo" required>

  <label>Selecciona la imagen (JPG/PNG):</label>
  <input type="file" id="archivo" accept=".jpg,.jpeg,.png" required>

  <label>GitHub Personal Access Token:</label>
  <input type="password" id="token" required placeholder="Introduce tu PAT">

  <button type="submit">Subir</button>
</form>

<p id="status"></p>

<script>
document.getElementById('uploadForm').addEventListener('submit', async e => {
  e.preventDefault();
  const titulo = document.getElementById('titulo').value.trim();
  const file = document.getElementById('archivo').files[0];
  const token = document.getElementById('token').value.trim();
  const status = document.getElementById('status');

  if(!file) return alert('Selecciona un archivo');

  const repo = '3dprintsbyrodrigo/3dprintsbyrodrigo.github.io'; // ajusta si tu repo tiene otro nombre
  const branch = 'main'; // cambia si tu repo usa master
  const path = `uploads/${file.name}`;

  const reader = new FileReader();
  reader.onloadend = async () => {
    const content = reader.result.split(',')[1];

    try {
      // 1️⃣ Comprobar si el archivo existe
      let sha;
      const getResp = await fetch(`https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`, {
        headers: { 'Authorization': `token ${token}` }
      });
      if(getResp.status === 200){
        const data = await getResp.json();
        sha = data.sha;
      }

      // 2️⃣ Subir o actualizar archivo
      const putResp = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
        method: 'PUT',
        headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: `Subida: ${file.name}`,
          content: content,
          sha: sha,
          branch: branch
        })
      });

      const putData = await putResp.json();
      if(putData.content){
        status.innerText = '¡Imagen subida! GitHub Actions actualizará la galería automáticamente.';
        document.getElementById('uploadForm').reset();
      } else {
        status.innerText = 'Error: ' + (putData.message || JSON.stringify(putData));
      }

    } catch(err){
      status.innerText = 'Error de conexión: ' + err;
    }
  };

  reader.readAsDataURL(file);
});
</script>

</body>
</html>
